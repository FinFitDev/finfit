<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Discount Scanner</title>

    <script src="https://unpkg.com/html5-qrcode" defer></script>

    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: system-ui, sans-serif;
        margin: 0;
        padding: 0;
        background: #f4f7f9;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        padding: 16px;
      }

      .card {
        width: 100%;
        max-width: 700px;
        min-height: calc(100vh - 32px);
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
      }

      .login-small {
        width: 100%;
        font-size: 16px;
      }

      .card-header {
        width: 100%;
        background: #eaeaea;
        color: rgb(0, 0, 0);
        padding: 18px;
        text-align: center;
        font-size: 20px;
        letter-spacing: 0.4px;
        font-weight: 600;
      }

      .card-content {
        width: 100%;
        padding: 32px 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow: hidden;
      }

      input {
        padding: 14px;
        margin-top: 12px;
        width: 100%;
        font-size: 16px;
        border-radius: 8px;
        border: 1px solid #cccccc;
        outline: none;
      }

      button {
        margin-top: 12px;
        width: 100%;
        padding: 14px;
        font-size: 16px;
        background: #0077ff;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.2s ease-in-out;
      }

      button:hover {
        background: #005fcc;
      }

      #scanner {
        margin-top: 20px;
        width: 100%;
        max-width: 450px;
        border-radius: 12px;
        overflow: hidden;
      }

      #shopInfo {
        display: none;
        flex-direction: column;
        align-items: center;
        margin-bottom: 20px;
        text-align: center;
      }

      #shopLogo {
        width: 100px;
        height: 100px;
        border-radius: 12px;
        object-fit: cover;
        margin-bottom: 10px;
        border: 2px solid #eee;
      }

      #result {
        margin-top: 18px;
        font-weight: bold;
        color: #0077ff;
      }

      #logoutBtn {
        background: #ececec;
        color: black;
      }

      #logoutBtn:hover {
        background: #d5d5d5;
      }
    </style>
  </head>

  <body>
    <!-- LOGIN SCREEN -->
    <div id="login" class="card">
      <div class="card-header" id="loginHeader">Partner Login</div>
      <div class="card-content">
        <img
          width="300px"
          style="border-radius: 200px"
          src="https://finfitdev.github.io/registry/bradning/images/icon.png"
        />
        <input
          id="secretInput"
          type="password"
          placeholder="Enter Access Code"
        />

        <p id="loginError" style="color: red"></p>
        <button class="login-small" onclick="login()">Login</button>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="card" style="display: none">
      <div class="card-header" id="dashboardHeader">Partner Dashboard</div>

      <div class="card-content">
        <div
          id="shopInfo"
          style="display: flex; flex-direction: row; gap: 16px"
        >
          <img id="shopLogo" src="" alt="Shop Logo" />
          <h2 id="shopName"></h2>
        </div>

        <div id="scanner" style="min-height: 350px"></div>

        <input id="textCode" placeholder="Or type code manually" />

        <!-- NEW: First check button -->
        <button onclick="checkCode()">Check Code</button>

        <!-- NEW: Hidden until code is validated -->
        <button id="markUsedBtn" onclick="triggerMark()" style="display: none">
          Mark Code as Used
        </button>

        <p id="result"></p>

        <button id="logoutBtn" onclick="logout()">Logout</button>
      </div>
    </div>

    <script>
      const BACKEND_URL = "https://stay-oops-index-conflict.trycloudflare.com";
      const SESSION_DURATION = 15 * 60 * 1000;

      async function login() {
        const secret = document.getElementById("secretInput").value.trim();
        if (!secret) return;

        const res = await fetch(`${BACKEND_URL}/auth/shop/verify`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token: secret }),
        });

        const data = await res.json();

        if (data.content) {
          // Store access_token along with shop data and expiration
          const sessionObj = {
            data: data.content,
            token: data.access_token,
            expiresAt: Date.now() + SESSION_DURATION,
          };
          localStorage.setItem("SHOP_DATA", JSON.stringify(sessionObj));
          showDashboard();
        } else {
          document.getElementById("loginError").innerText =
            "Invalid access code.";
        }
      }

      function showDashboard() {
        document.getElementById("login").style.display = "none";
        document.getElementById("dashboard").style.display = "flex";

        const saved = JSON.parse(localStorage.getItem("SHOP_DATA"));
        if (saved?.data) {
          document.getElementById("shopName").innerText = saved.data.name;
          document.getElementById("shopLogo").src = saved.data.image;
          document.getElementById("shopInfo").style.display = "flex";
        }

        startScanner();
      }

      function startScanner() {
        const scannerContainer = document.getElementById("scanner");
        const html5QrCode = new Html5Qrcode("scanner");

        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 300 },
          (decodedText) => {
            console.log(decodedText);
            document.getElementById("textCode").value = decodedText;
          }
        );
      }

      async function checkCode(scannedText = null) {
        const resultEl = document.getElementById("result");
        resultEl.innerText = "";
        resultEl.style.color = "#0077ff";

        const code =
          scannedText ?? document.getElementById("textCode").value.trim();
        if (!code) return;

        const session = JSON.parse(localStorage.getItem("SHOP_DATA"));
        if (!session || Date.now() > session.expiresAt) return logout();

        try {
          const res = await fetch(
            `${BACKEND_URL}/upon-delivery/code/check/${code}`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${session.token}`,
                "Content-Type": "application/json",
              },

              body: JSON.stringify({
                partner_id: session.data.uuid,
              }),
            }
          );
          console.log(res);

          const data = await res.json();

          if (data.error) {
            if (data.error === "Token invalid or expired") return logout();
            throw new Error(data.error);
          }

          if (data.content === true) {
            resultEl.innerText = data.message;
            resultEl.style.color = "#0077ff";
            document.getElementById("markUsedBtn").style.display = "block";
            document.getElementById("markUsedBtn").dataset.code = code;
          } else {
            resultEl.innerText = data.message || "Invalid code.";
            resultEl.style.color = "red";
            document.getElementById("markUsedBtn").style.display = "none";
          }
        } catch (err) {
          resultEl.innerText = "Invalid code";
          resultEl.style.color = "red";
          document.getElementById("markUsedBtn").style.display = "none";
        }
      }

      function triggerMark() {
        const confirmed = confirm(
          "Are you sure you want to mark the code as used? This action cannot be undone"
        );
        if (confirmed) {
          markCodeUsed();
        }
      }

      async function markCodeUsed() {
        const code = document.getElementById("markUsedBtn").dataset.code;
        if (!code) return;

        const session = JSON.parse(localStorage.getItem("SHOP_DATA"));

        const res = await fetch(
          `${BACKEND_URL}/upon-delivery/code/mark/${code}`,
          {
            method: "POST",
            headers: {
              Authorization: `Bearer ${session.token}`,
              "Content-Type": "application/json",
            },
          }
        );

        const data = await res.json();
        document.getElementById("result").innerText = data.message;
        document.getElementById("markUsedBtn").style.display = "none";
      }

      function logout() {
        localStorage.removeItem("SHOP_DATA");
        location.reload();
      }

      window.onload = () => {
        const saved = JSON.parse(localStorage.getItem("SHOP_DATA"));
        if (saved && Date.now() < saved.expiresAt) showDashboard();
      };
    </script>
  </body>
</html>

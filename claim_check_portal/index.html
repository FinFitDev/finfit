<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Claim Check Portal</title>

    <script src="https://unpkg.com/html5-qrcode" defer></script>

    <style>
      :root {
        --bg: #edf1f7;
        --surface: #ffffff;
        --surface-alt: #f8fafc;
        --primary: rgb(83, 132, 245);
        --primary-dark: #2044b3;
        --accent: #03c6a1;
        --danger: #f15656;
        --text: #111822;
        --muted: #5b6574;
        --border: #e1e6ef;
        --shadow: 0 15px 35px rgba(30, 38, 58, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        background: var(--bg);
        color: var(--text);
        margin: 0;
        min-height: 100vh;
        padding: 40px 20px 60px;
        display: flex;
        justify-content: center;
        position: relative;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background: radial-gradient(
            circle at 20% 20%,
            rgba(47, 98, 255, 0.2),
            transparent 40%
          ),
          radial-gradient(
            circle at 80% 0%,
            rgba(3, 198, 161, 0.15),
            transparent 40%
          ),
          linear-gradient(135deg, rgba(255, 255, 255, 0.6), transparent 65%);
        z-index: 0;
      }

      main.portal-shell {
        width: min(1200px, 100%);
        display: flex;
        flex-direction: column;
        gap: 28px;
        position: relative;
        z-index: 1;
      }

      .hero {
        background: var(--surface);
        border-radius: 20px;
        padding: 32px;
        box-shadow: var(--shadow);
        text-align: center;
      }

      .eyebrow {
        letter-spacing: 0.16em;
        text-transform: uppercase;
        font-size: 11px;
        color: var(--muted);
        margin: 0 0 10px;
      }

      h1 {
        font-size: clamp(2.1rem, 4vw, 2.8rem);
        margin: 0 0 12px;
      }

      .hero p {
        color: var(--muted);
        max-width: 640px;
        margin: 0 auto 18px;
        font-size: 1rem;
        line-height: 1.5;
      }

      .pill-group {
        display: inline-flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 12px;
        margin-top: 12px;
      }

      .pill {
        background: var(--surface-alt);
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 8px 16px;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .layout-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 24px;
      }

      .card {
        background: var(--surface);
        border-radius: 20px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
      }

      .card-header {
        padding: 26px 28px 18px;
        border-bottom: 1px solid var(--border);
      }

      .card-header h2 {
        margin: 4px 0 0;
        font-size: 1.4rem;
      }

      .card-content {
        padding: 26px 28px 32px;
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      input,
      button {
        font: inherit;
      }

      input {
        width: 100%;
        padding: 15px 16px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--surface-alt);
        font-size: 1rem;
        transition: border 0.2s ease, box-shadow 0.2s ease;
      }

      input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(47, 98, 255, 0.15);
        outline: none;
      }

      .field-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--muted);
      }

      .btn {
        border: none;
        border-radius: 12px;
        padding: 14px 18px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.15s ease, background 0.15s ease,
          box-shadow 0.15s ease;
      }

      .btn:active {
        transform: translateY(1px);
      }

      .btn-primary {
        background: var(--primary);
        color: #fff;
        box-shadow: 0 8px 20px rgba(47, 98, 255, 0.2);
      }

      .btn-primary:hover {
        background: var(--primary-dark);
      }

      .btn-secondary {
        background: var(--surface);
        border: 1px solid var(--border);
        color: var(--text);
      }

      .btn-secondary:hover {
        border-color: var(--primary);
        color: var(--primary-dark);
      }

      .btn-ghost {
        background: transparent;
        color: var(--muted);
        border: 1px solid transparent;
        padding-inline: 10px;
      }

      .btn-ghost:hover {
        color: var(--text);
      }

      .btn-danger {
        background: var(--danger);
        color: #fff;
        box-shadow: 0 8px 20px rgba(241, 86, 86, 0.3);
      }

      .status-message {
        min-height: 24px;
        font-weight: 600;
        color: var(--muted);
      }

      .status-message.error {
        color: var(--danger);
      }

      #scanner {
        width: 100%;
        min-height: 360px;
        border-radius: 16px;
        border: 1px dashed var(--border);
        background: repeating-linear-gradient(
            135deg,
            rgba(47, 98, 255, 0.04),
            rgba(47, 98, 255, 0.04) 20px,
            transparent 20px,
            transparent 40px
          ),
          var(--surface-alt);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
      }

      #shopInfo {
        display: none;
        align-items: center;
        gap: 16px;
        padding: 18px;
        background: var(--surface-alt);
        border-radius: 16px;
      }

      #shopLogo {
        width: 72px;
        height: 72px;
        object-fit: cover;
        border-radius: 16px;
        border: 1px solid var(--border);
      }

      #result {
        padding: 12px 16px;
        border-radius: 12px;
        background: var(--surface-alt);
      }

      #productListContainer {
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        background: #fff;
      }

      #productList {
        margin: 12px 0 0;
        padding: 0;
        list-style: none;
        display: grid;
        gap: 10px;
      }

      #productList li {
        padding: 10px 14px;
        border-radius: 12px;
        background: var(--surface-alt);
        border: 1px solid var(--border);
        color: var(--muted);
      }

      .info-card {
        gap: 0;
      }

      .info-card ul {
        list-style: none;
        padding: 0 28px 32px;
        margin: 0;
        display: grid;
        gap: 12px;
      }

      .info-card li {
        padding: 16px;
        border-radius: 14px;
        background: var(--surface-alt);
        border: 1px solid var(--border);
      }

      .helper-text {
        font-size: 0.85rem;
        color: var(--muted);
        margin: 0;
      }

      footer {
        text-align: center;
        color: var(--muted);
        font-size: 0.85rem;
      }

      @media (max-width: 640px) {
        body {
          padding: 24px 16px 40px;
        }

        .card-header,
        .card-content {
          padding: 22px;
        }

        #scanner {
          min-height: 280px;
        }

        .hero {
          padding: 24px;
        }
      }
    </style>
  </head>

  <body>
    <main class="portal-shell">
      <section class="hero">
        <p class="eyebrow">FinFit Partner Portal</p>
        <h1>Claim Check</h1>
        <p>
          A clean way to validate discount codes upon delivery. Log in with your
          secure partner credential, scan or enter the code, review the eligible
          products, then mark the claim as used in a single flow.
        </p>
        <div class="pill-group">
          <span class="pill">Secure access</span>
          <span class="pill">Real-time verification</span>
          <span class="pill">Product-level visibility</span>
        </div>
      </section>

      <section class="layout-grid">
        <div class="card" id="login">
          <div class="card-header">
            <p class="eyebrow">Partner Login</p>
            <h2>Authenticate to begin</h2>
          </div>
          <div class="card-content">
            <div
              style="
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 18px;
                border-radius: 16px;
                background: var(--surface-alt);
              "
            >
              <img
                src="https://finfitdev.github.io/registry/bradning/images/icon.png"
                alt="Excerbuys"
                style="width: 120px; height: 120px; border-radius: 999px"
              />
            </div>

            <label class="field-label" for="secretInput">Access code</label>
            <input
              id="secretInput"
              type="password"
              placeholder="Enter access code"
              autocomplete="current-password"
            />
            <p id="loginError" class="status-message error"></p>
            <button class="btn btn-primary" onclick="login()">
              Access dashboard
            </button>
            <p class="helper-text">
              Having trouble? Reach your Excerbuys success partner for help.
            </p>
          </div>
        </div>

        <div class="card" id="dashboard" style="display: none">
          <div
            class="card-header"
            style="
              display: flex;
              justify-content: space-between;
              align-items: flex-start;
              gap: 12px;
            "
            id="dashboardHeader"
          >
            <div>
              <p class="eyebrow">Partner Dashboard</p>
              <h2>Scan &amp; verify discounts</h2>
            </div>
            <button class="btn btn-ghost" id="logoutBtn" onclick="logout()">
              Logout
            </button>
          </div>
          <div class="card-content">
            <div id="shopInfo">
              <img id="shopLogo" src="" alt="Shop Logo" />
              <div>
                <p class="eyebrow">Currently serving</p>
                <h3 id="shopName" style="margin: 4px 0 0"></h3>
              </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 6px">
              <p class="field-label">Camera scanner</p>
              <small class="helper-text"
                >Point the device at the customer QR.</small
              >
              <div id="scanner"></div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 8px">
              <label class="field-label" for="textCode">Manual entry</label>
              <input
                id="textCode"
                placeholder="Or type code manually"
                inputmode="numeric"
              />
              <button class="btn btn-secondary" onclick="checkCode()">
                Check code
              </button>
            </div>

            <button
              id="markUsedBtn"
              class="btn btn-danger"
              onclick="triggerMark()"
              style="display: none"
            >
              Mark code as used
            </button>

            <p id="result" class="status-message"></p>

            <div id="productListContainer" style="display: none">
              <div
                style="
                  display: flex;
                  flex-direction: column;
                  gap: 4px;
                  margin-bottom: 6px;
                "
              >
                <h4 style="margin: 0">Eligible products</h4>
                <p class="helper-text">
                  Double-check that the order lines up with the code
                  permissions.
                </p>
              </div>
              <ul id="productList"></ul>
            </div>
          </div>
        </div>
      </section>

      <section class="card info-card">
        <div class="card-header">
          <p class="eyebrow">Quick guidance</p>
          <h2>How the process works</h2>
        </div>
        <ul style="padding-top: 16px">
          <li>
            <strong>1. Authenticate securely.</strong> Use your rotating access
            code. Sessions expire automatically after 15 minutes of inactivity.
          </li>
          <li>
            <strong>2. Scan or type the code.</strong> Let the camera lock onto
            the QR, or paste the value in manually if the label is damaged.
          </li>
          <li>
            <strong>3. Review the payload.</strong> We highlight every product
            attached to the discount so you can verify before handing off the
            order.
          </li>
          <li>
            <strong>4. Mark it used.</strong> Once the delivery is confirmed,
            mark the code as used to prevent accidental reuse.
          </li>
        </ul>
      </section>

      <footer>Â© <span id="year"></span> Excerbuys. All rights reserved.</footer>
    </main>

    <script>
      const BACKEND_URL =
        "https://brakes-sharing-society-technician.trycloudflare.com";
      const SESSION_DURATION = 15 * 60 * 1000;

      document.getElementById("year").textContent = new Date().getFullYear();

      async function login() {
        const secret = document.getElementById("secretInput").value.trim();
        if (!secret) return;

        const res = await fetch(`${BACKEND_URL}/auth/shop/verify`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token: secret }),
        });

        const data = await res.json();

        if (data.content) {
          const sessionObj = {
            data: data.content,
            token: data.access_token,
            expiresAt: Date.now() + SESSION_DURATION,
          };
          localStorage.setItem("SHOP_DATA", JSON.stringify(sessionObj));
          showDashboard();
          document.getElementById("loginError").innerText = "";
        } else {
          document.getElementById("loginError").innerText =
            "Invalid access code.";
        }
      }

      function showDashboard() {
        document.getElementById("login").style.display = "none";
        document.getElementById("dashboard").style.display = "flex";

        const saved = JSON.parse(localStorage.getItem("SHOP_DATA"));
        if (saved?.data) {
          document.getElementById("shopName").innerText = saved.data.name;
          document.getElementById("shopLogo").src = saved.data.image;
          document.getElementById("shopInfo").style.display = "flex";
        }

        startScanner();
      }

      function startScanner() {
        const html5QrCode = new Html5Qrcode("scanner");

        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 300 },
          (decodedText) => {
            document.getElementById("textCode").value = decodedText;
          }
        );
      }

      async function checkCode(scannedText = null) {
        const resultEl = document.getElementById("result");
        resultEl.innerText = "";
        resultEl.style.color = varColor("--primary");

        const code =
          scannedText ?? document.getElementById("textCode").value.trim();
        if (!code) return;

        const session = JSON.parse(localStorage.getItem("SHOP_DATA"));
        if (!session || Date.now() > session.expiresAt) return logout();

        try {
          const res = await fetch(
            `${BACKEND_URL}/upon-delivery/code/check/${code}`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${session.token}`,
                "Content-Type": "application/json",
              },

              body: JSON.stringify({
                partner_id: session.data.uuid,
              }),
            }
          );

          const data = await res.json();

          if (data.error) {
            if (data.error === "Token invalid or expired") return logout();
            throw new Error(data.error);
          }

          if (data.content.valid === true) {
            resultEl.innerText = data.message;
            resultEl.style.color = varColor("--primary");
            document.getElementById("markUsedBtn").style.display = "block";
            document.getElementById("markUsedBtn").dataset.code = code;
            const productListEl = document.getElementById("productList");
            productListEl.innerHTML = "";
            const payload = data.content.payload;
            if (payload.products && payload.products.length > 0) {
              document.getElementById("productListContainer").style.display =
                "block";
              productListEl.style.display = "grid";

              payload.products.forEach((p) => {
                const li = document.createElement("li");
                li.innerText = p;
                productListEl.appendChild(li);
              });
            } else {
              productListEl.style.display = "none";
            }
          } else {
            handleInvalid(resultEl, data.message || "Invalid code.");
          }
        } catch (err) {
          handleInvalid(resultEl, "Invalid code");
        }
      }

      function handleInvalid(resultEl, message) {
        resultEl.innerText = message;
        resultEl.style.color = varColor("--danger");
        document.getElementById("markUsedBtn").style.display = "none";
        document.getElementById("productList").style.display = "none";
        document.getElementById("productListContainer").style.display = "none";
      }

      function triggerMark() {
        const confirmed = confirm(
          "Are you sure you want to mark the code as used? This action cannot be undone. Make sure the code is valid for the product being sold"
        );
        if (confirmed) {
          markCodeUsed();
        }
      }

      async function markCodeUsed() {
        const code = document.getElementById("markUsedBtn").dataset.code;
        if (!code) return;

        const session = JSON.parse(localStorage.getItem("SHOP_DATA"));

        const res = await fetch(
          `${BACKEND_URL}/upon-delivery/code/mark/${code}`,
          {
            method: "POST",
            headers: {
              Authorization: `Bearer ${session.token}`,
              "Content-Type": "application/json",
            },
          }
        );

        const data = await res.json();
        const resultEl = document.getElementById("result");
        resultEl.innerText = data.message;
        resultEl.style.color = varColor("--primary");
        document.getElementById("markUsedBtn").style.display = "none";
      }

      function logout() {
        localStorage.removeItem("SHOP_DATA");
        location.reload();
      }

      window.onload = () => {
        const saved = JSON.parse(localStorage.getItem("SHOP_DATA"));
        if (saved && Date.now() < saved.expiresAt) showDashboard();
      };

      function varColor(token) {
        return getComputedStyle(document.documentElement).getPropertyValue(
          token
        );
      }
    </script>
  </body>
</html>
